name: Build and Release

on:
  push:
    tags:
      - 'v*' # à¹€à¸¡à¸·à¹ˆà¸­à¸¡à¸µ tag à¸—à¸µà¹ˆà¸‚à¸¶à¹‰à¸™à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢ 'v' à¹€à¸Šà¹ˆà¸™ v1.0.0
  workflow_dispatch: # à¸ªà¸²à¸¡à¸²à¸£à¸– run manual à¹„à¸”à¹‰

env:
  FLUTTER_VERSION: '3.29.3'

jobs:
  # ðŸ—ï¸ Build for Windows
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows EXE
        run: flutter build windows --release

      - name: Create Windows Installer
        run: |
          # à¹ƒà¸Šà¹‰ Inno Setup à¸«à¸£à¸·à¸­ NSIS à¸ªà¸£à¹‰à¸²à¸‡ installer
          # à¸ªà¸³à¸«à¸£à¸±à¸šà¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸™à¸µà¹‰à¹€à¸£à¸²à¸ˆà¸° zip à¹„à¸Ÿà¸¥à¹Œ
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath "InternApp-Windows-${{ github.ref_name }}.zip"

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: "InternApp-Windows-${{ github.ref_name }}.zip"

  # ðŸŽ Build for macOS
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build macOS App
        run: flutter build macos --release

      - name: Create DMG
        run: |
          # à¸ªà¸£à¹‰à¸²à¸‡ DMG file
          mkdir -p dist
          cp -R build/macos/Build/Products/Release/project.app dist/
          hdiutil create -volname "InternApp" -srcfolder dist -ov -format UDZO "InternApp-macOS-${{ github.ref_name }}.dmg"

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: "InternApp-macOS-${{ github.ref_name }}.dmg"

  # ðŸ§ Build for Linux
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux App
        run: flutter build linux --release

      - name: Create AppImage
        run: |
          # à¸ªà¸£à¹‰à¸²à¸‡ AppImage (à¸•à¹‰à¸­à¸‡à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ appimagetool à¸à¹ˆà¸­à¸™)
          wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool
          
          # à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡ AppDir
          mkdir -p AppDir/usr/bin
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          
          # à¸ªà¸£à¹‰à¸²à¸‡ desktop file
          cat > AppDir/InternApp.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=InternApp
          Exec=AppRun
          Icon=icon
          Categories=Utility;
          EOF
          
          # à¸ªà¸£à¹‰à¸²à¸‡ AppRun script
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          exec "${HERE}/usr/bin/project" "$@"
          EOF
          chmod +x AppDir/AppRun
          
          # à¸ªà¸£à¹‰à¸²à¸‡ AppImage
          ./appimagetool AppDir "InternApp-Linux-${{ github.ref_name }}.AppImage"

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: "InternApp-Linux-${{ github.ref_name }}.AppImage"

  # ðŸš€ Create Release
  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## ðŸŽ‰ InternApp ${{ github.ref_name }}
            
            ### ðŸ“¥ Downloads
            - **Windows**: InternApp-Windows-${{ github.ref_name }}.zip
            - **macOS**: InternApp-macOS-${{ github.ref_name }}.dmg  
            - **Linux**: InternApp-Linux-${{ github.ref_name }}.AppImage
            
            ### ðŸ”„ Auto Update
            à¹à¸­à¸›à¸žà¸¥à¸´à¹€à¸„à¸Šà¸±à¸™à¸ˆà¸°à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸­à¸±à¸›à¹€à¸”à¸•à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸—à¸¸à¸ 6 à¸Šà¸±à¹ˆà¸§à¹‚à¸¡à¸‡
            à¸«à¸£à¸·à¸­à¸ªà¸²à¸¡à¸²à¸£à¸–à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸”à¹‰à¸§à¸¢à¸•à¸™à¹€à¸­à¸‡à¹„à¸”à¹‰à¹ƒà¸™à¸«à¸™à¹‰à¸²à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²
            
            ### ðŸ“‹ à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸à¸²à¸£à¸­à¸±à¸›à¹€à¸”à¸•
            - Bug fixes à¹à¸¥à¸° improvements
            - à¹€à¸žà¸´à¹ˆà¸¡à¸Ÿà¸µà¹€à¸ˆà¸­à¸£à¹Œà¹ƒà¸«à¸¡à¹ˆ
            - à¸›à¸£à¸±à¸šà¸›à¸£à¸¸à¸‡à¸›à¸£à¸°à¸ªà¸´à¸—à¸˜à¸´à¸ à¸²à¸ž
            
            ---
            **Installation**: à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸à¸±à¸šà¸£à¸°à¸šà¸šà¸›à¸à¸´à¸šà¸±à¸•à¸´à¸à¸²à¸£à¸‚à¸­à¸‡à¸„à¸¸à¸“
          draft: false
          prerelease: false

      - name: Upload Windows Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: windows-build/InternApp-Windows-${{ github.ref_name }}.zip
          asset_name: InternApp-Windows-${{ github.ref_name }}.zip
          asset_content_type: application/zip

      - name: Upload macOS Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: macos-build/InternApp-macOS-${{ github.ref_name }}.dmg
          asset_name: InternApp-macOS-${{ github.ref_name }}.dmg
          asset_content_type: application/octet-stream

      - name: Upload Linux Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: linux-build/InternApp-Linux-${{ github.ref_name }}.AppImage
          asset_name: InternApp-Linux-${{ github.ref_name }}.AppImage
          asset_content_type: application/octet-stream
